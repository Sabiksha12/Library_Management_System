import java.util.*;
import java.time.*;

class Book {
    String isbn, title, author;
    int quantity;
    double price;
    int borrowCount = 0;

    Book(String isbn, String title, String author, int quantity, double price) {
        this.isbn = isbn;
        this.title = title;
        this.author = author;
        this.quantity = quantity;
        this.price = price;
    }

    public String toString() {
        return String.format("ISBN: %s | Title: %s | Author: %s | Qty: %d | Price: %.2f",
                isbn, title, author, quantity, price);
    }
}

class User {
    String email, password, role;
    double deposit = 1500.0;
    List<String> borrowedBooks = new ArrayList<>();
    List<String> borrowDates = new ArrayList<>();
    List<String> fineHistory = new ArrayList<>();
    List<String> pastBorrowedBooks = new ArrayList<>();

    User(String email, String password, String role) {
        this.email = email;
        this.password = password;
        this.role = role;
    }
}

public class LibrarySystem {
    static Scanner sc = new Scanner(System.in);
    static Map<String, Book> bookMap = new HashMap<>();
    static Map<String, User> users = new HashMap<>();

    public static void main(String[] args) {
        users.put("admin@lib.com", new User("admin@lib.com", "admin123", "admin"));
        users.put("stud@lib.com", new User("stud@lib.com", "stud123", "borrower"));

        while (true) {
            System.out.println("\n===== LIBRARY SYSTEM LOGIN =====");
            System.out.print("Email: ");
            String email = sc.nextLine();
            System.out.print("Password: ");
            String pass = sc.nextLine();

            if (users.containsKey(email) && users.get(email).password.equals(pass)) {
                String role = users.get(email).role;
                System.out.println("\nLogin successful as " + role.toUpperCase());

                if (role.equals("admin")) {
                    adminMenu(email);
                } else {
                    borrowerMenu(email);
                }
            } else {
                System.out.println("Invalid credentials.");
            }
        }
    }

    public static void adminMenu(String email) {
        while (true) {
            System.out.println("\n--- ADMIN MENU ---");
            System.out.println("1. Add Book\n2. View Books\n3. Search Book\n4. Delete Book\n5. Add User\n6. Logout");
            System.out.print("Choice: ");
            int ch = sc.nextInt();
            sc.nextLine();

            switch (ch) {
                case 1: addBook(); break;
                case 2: viewBooks(); break;
                case 3: searchBook(); break;
                case 4: deleteBook(); break;
                case 5: addUser(); break;
                case 6: return;
                default: System.out.println("Invalid choice");
            }
        }
    }

    public static void borrowerMenu(String email) {
        User user = users.get(email);

        while (true) {
            System.out.println("\n--- BORROWER MENU ---");
            System.out.println("1. View Books\n2. Borrow Book\n3. View Borrowed\n4. Return Book\n5. View Fine History\n6. View Past Borrowed\n7. Logout");
            System.out.print("Choice: ");
            int ch = sc.nextInt();
            sc.nextLine();

            switch (ch) {
                case 1: viewBooks(); break;
                case 2: borrowBook(user); break;
                case 3: showBorrowedBooks(user); break;
                case 4: returnBook(user); break;
                case 5:
                    for (String fine : user.fineHistory) {
                        System.out.println(fine);
                    }
                    break;
                case 6:
                    for (String title : user.pastBorrowedBooks) {
                        System.out.println(title);
                    }
                    break;
                case 7: return;
                default: System.out.println("Invalid choice");
            }
        }
    }

    public static void addBook() {
        System.out.print("ISBN: ");
        String isbn = sc.nextLine();
        System.out.print("Title: ");
        String title = sc.nextLine();
        System.out.print("Author: ");
        String author = sc.nextLine();
        System.out.print("Quantity: ");
        int qty = sc.nextInt();
        System.out.print("Price: ");
        double price = sc.nextDouble();
        sc.nextLine();

        bookMap.put(isbn, new Book(isbn, title, author, qty, price));
        System.out.println("Book added.");
    }

    public static void viewBooks() {
        System.out.println("\n--- Book List ---");
        for (Book b : bookMap.values()) {
            System.out.println(b);
        }
    }

    public static void searchBook() {
        System.out.print("Enter ISBN or Title: ");
        String key = sc.nextLine();
        for (Book b : bookMap.values()) {
            if (b.title.equalsIgnoreCase(key) || b.isbn.equalsIgnoreCase(key)) {
                System.out.println(b);
                return;
            }
        }
        System.out.println("Book not found.");
    }

    public static void deleteBook() {
        System.out.print("Enter ISBN to delete: ");
        String isbn = sc.nextLine();
        if (bookMap.remove(isbn) != null) {
            System.out.println("Book deleted.");
        } else {
            System.out.println("Book not found.");
        } 
    }

    public static void addUser() {
        System.out.print("Enter Email: ");
        String email = sc.nextLine();
        System.out.print("Password: ");
        String pass = sc.nextLine();
        System.out.print("Role (admin/borrower): ");
        String role = sc.nextLine();
        users.put(email, new User(email, pass, role));
        System.out.println("User added.");
    }

    public static void borrowBook(User user) {
        if (user.borrowedBooks.size() >= 3) {
            System.out.println("You already borrowed 3 books!");
            return;
        }
        if (user.deposit < 500) {
            System.out.println("Maintain a minimum deposit of ₹500.");
            return;
        }

        System.out.print("Enter ISBN: ");
        String isbn = sc.nextLine();
        Book book = bookMap.get(isbn);

        if (book == null || book.quantity <= 0) {
            System.out.println("Book not available.");
            return;
        }

        if (user.borrowedBooks.contains(isbn)) {
            System.out.println("You already borrowed this book.");
            return;
        }

        book.quantity--;
        book.borrowCount++;
        user.borrowedBooks.add(isbn);
        user.borrowDates.add(LocalDate.now().toString());
        user.pastBorrowedBooks.add(book.title);
        System.out.println("Book borrowed successfully!");
    }

    public static void showBorrowedBooks(User user) {
        System.out.println("--- Your Borrowed Books ---");
        for (int i = 0; i < user.borrowedBooks.size(); i++) {
            String isbn = user.borrowedBooks.get(i);
            String date = user.borrowDates.get(i);
            Book book = bookMap.get(isbn);
            System.out.println(book + " | Borrowed on: " + date);
        }
    }

    public static void returnBook(User user) {
        System.out.print("Enter ISBN to return: ");
        String isbn = sc.nextLine();

        int index = user.borrowedBooks.indexOf(isbn);
        if (index == -1) {
            System.out.println("You did not borrow this book.");
            return;
        }

        Book book = bookMap.get(isbn);
        book.quantity++;

        String borrowDate = user.borrowDates.get(index);
        LocalDate borrow = LocalDate.parse(borrowDate);
        LocalDate today = LocalDate.now();
        long days = Duration.between(borrow.atStartOfDay(), today.atStartOfDay()).toDays();

        if (days > 15) {
            long overdue = days - 15;
            double fine = Math.min(overdue * 2, book.price * 0.8);
            user.deposit -= fine;
            String msg = "Fine of ₹" + fine + " for late return of " + book.title;
            user.fineHistory.add(msg);
            System.out.println(msg);
        } else {
            System.out.println("Book returned successfully with no fine.");
        }

        user.borrowedBooks.remove(index);
        user.borrowDates.remove(index);
    }
}
